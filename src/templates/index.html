<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Skate Physics Preserver</title>
<style>
/* ================================================================
   THEME & RESET
   ================================================================ */
:root {
  --bg:          #07070d;
  --surface:     #111122;
  --surface-2:   #181830;
  --surface-3:   #222240;
  --border:      #2a2a48;
  --border-l:    #363660;
  --text:        #e4e4f0;
  --text-dim:    #7878a0;
  --text-muted:  #50506e;
  --primary:     #6366f1;
  --primary-h:   #818cf8;
  --primary-bg:  rgba(99,102,241,.08);
  --success:     #22c55e;
  --success-bg:  rgba(34,197,94,.08);
  --warning:     #eab308;
  --danger:      #ef4444;
  --skater:      #3b82f6;
  --skateboard:  #f97316;
  --radius:      12px;
  --radius-sm:   8px;
  --shadow:      0 4px 24px rgba(0,0,0,.45);
  --shadow-lg:   0 8px 40px rgba(0,0,0,.55);
}
*, *::before, *::after { margin:0; padding:0; box-sizing:border-box; }
html { font-size: 15px; }
body {
  font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
  background: var(--bg);
  color: var(--text);
  min-height: 100vh;
  display: flex;
  flex-direction: column;
  align-items: center;
}
a { color: var(--primary-h); text-decoration: none; }

/* ================================================================
   HEADER
   ================================================================ */
.header {
  width: 100%;
  padding: 24px 0 0;
  text-align: center;
  background: linear-gradient(180deg, #0e0e1c 0%, var(--bg) 100%);
}
.header h1 {
  font-size: 1.5rem;
  font-weight: 700;
  letter-spacing: -.02em;
}
.header p {
  color: var(--text-dim);
  font-size: .82rem;
  margin-top: 2px;
}

/* ================================================================
   STEPPER  (horizontal step indicator)
   ================================================================ */
.stepper-wrap {
  width: 100%;
  max-width: 720px;
  margin: 20px auto 0;
  padding: 0 16px;
}
.stepper {
  display: flex;
  align-items: flex-start;
  position: relative;
}
.stepper-step {
  flex: 1;
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: 6px;
  position: relative;
  z-index: 1;
}
.stepper-circle {
  width: 34px;
  height: 34px;
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  font-weight: 700;
  font-size: .82rem;
  border: 2px solid var(--border);
  background: var(--surface);
  color: var(--text-dim);
  transition: all .35s ease;
}
.stepper-step.active .stepper-circle {
  border-color: var(--primary);
  background: var(--primary);
  color: #fff;
  box-shadow: 0 0 0 4px rgba(99,102,241,.18);
}
.stepper-step.complete .stepper-circle {
  border-color: var(--success);
  background: var(--success);
  color: #fff;
}
.stepper-label {
  font-size: .72rem;
  color: var(--text-muted);
  font-weight: 500;
  text-transform: uppercase;
  letter-spacing: .04em;
  transition: color .3s;
}
.stepper-step.active .stepper-label  { color: var(--text); }
.stepper-step.complete .stepper-label { color: var(--success); }

/* Connecting lines */
.stepper-line {
  position: absolute;
  top: 16px;
  height: 2px;
  background: var(--border);
  transition: background .4s ease;
  z-index: 0;
}
.stepper-line.done { background: var(--success); }

/* ================================================================
   CONTAINER & STEP CARDS
   ================================================================ */
.container { width: 100%; max-width: 1020px; padding: 20px 16px 60px; }

.step {
  display: none;
  background: var(--surface);
  border: 1px solid var(--border);
  border-radius: var(--radius);
  padding: 28px 32px;
  margin-bottom: 20px;
  box-shadow: var(--shadow);
  animation: fadeUp .35s ease;
}
.step.active { display: block; }
@keyframes fadeUp {
  from { opacity:0; transform:translateY(10px); }
  to   { opacity:1; transform:translateY(0); }
}

.step-title {
  font-size: 1.1rem;
  font-weight: 600;
  margin-bottom: 4px;
}
.step-desc {
  color: var(--text-dim);
  font-size: .84rem;
  margin-bottom: 20px;
  line-height: 1.5;
}

/* ================================================================
   UPLOAD AREA
   ================================================================ */
.upload-zone {
  border: 2px dashed var(--border);
  border-radius: var(--radius);
  padding: 38px 20px;
  text-align: center;
  cursor: pointer;
  transition: border-color .2s, background .2s;
  margin-bottom: 16px;
}
.upload-zone:hover, .upload-zone.drag-over {
  border-color: var(--primary);
  background: var(--primary-bg);
}
.upload-zone .icon { font-size: 2.2rem; margin-bottom: 6px; }
.upload-zone p { color: var(--text-dim); font-size: .86rem; }

.or-divider {
  text-align: center;
  color: var(--text-dim);
  font-size: .78rem;
  margin: 14px 0;
  position: relative;
}
.or-divider::before, .or-divider::after {
  content:''; position:absolute; top:50%; width:calc(50% - 24px);
  height:1px; background:var(--border);
}
.or-divider::before { left:0; }
.or-divider::after  { right:0; }

.url-row { display:flex; gap:10px; }
.url-row input {
  flex: 1;
  background: var(--surface-2);
  border: 1px solid var(--border);
  border-radius: var(--radius-sm);
  padding: 10px 14px;
  color: var(--text);
  font-size: .88rem;
  outline: none;
  transition: border-color .2s;
}
.url-row input:focus { border-color: var(--primary); }
.url-row input::placeholder { color: var(--text-dim); }

/* Video info badge after upload */
.video-info {
  display: none;
  align-items: center;
  gap: 12px;
  background: var(--surface-2);
  border: 1px solid var(--border);
  border-radius: var(--radius-sm);
  padding: 10px 16px;
  margin-top: 12px;
  font-size: .84rem;
}
.video-info.show { display: flex; }
.video-info .vi-name { font-weight: 600; color: var(--text); }
.video-info .vi-meta { color: var(--text-dim); }

/* ================================================================
   BUTTONS
   ================================================================ */
.btn {
  display: inline-flex;
  align-items: center;
  justify-content: center;
  gap: 6px;
  padding: 10px 22px;
  border: none;
  border-radius: var(--radius-sm);
  font-size: .88rem;
  font-weight: 600;
  cursor: pointer;
  transition: background .2s, transform .1s, opacity .2s;
  color: #fff;
}
.btn:active { transform: scale(.97); }
.btn:disabled { opacity:.4; cursor:not-allowed; }
.btn-primary   { background: var(--primary); }
.btn-primary:hover:not(:disabled) { background: var(--primary-h); }
.btn-success   { background: var(--success); }
.btn-success:hover:not(:disabled) { background: #16a34a; }
.btn-warning   { background: var(--warning); color:#000; }
.btn-warning:hover:not(:disabled) { background: #ca8a04; }
.btn-danger    { background: var(--danger); }
.btn-danger:hover:not(:disabled)  { background: #dc2626; }
.btn-outline {
  background: transparent;
  border: 1px solid var(--border);
  color: var(--text);
}
.btn-outline:hover:not(:disabled) { border-color: var(--primary); color: var(--primary-h); }
.btn-sm { padding: 6px 14px; font-size: .8rem; }

.btn-row { display:flex; gap:10px; margin-top:20px; flex-wrap:wrap; }

/* ================================================================
   PREVIEW / DETECTION
   ================================================================ */
.preview-wrap {
  position: relative;
  border-radius: var(--radius);
  overflow: hidden;
  background: #000;
  margin-bottom: 16px;
  line-height: 0;
}
.preview-wrap img {
  width: 100%;
  height: auto;
  display: block;
}
.preview-wrap.clickable { cursor: crosshair; }

/* Detection legend */
.legend {
  display: flex;
  gap: 16px;
  margin-bottom: 10px;
  font-size: .82rem;
}
.legend-item { display:flex; align-items:center; gap:6px; }
.legend-dot {
  width: 12px; height: 12px; border-radius: 50%;
}
.legend-dot.skater     { background: var(--skater); }
.legend-dot.skateboard { background: var(--skateboard); }

.det-cards { display:flex; gap:10px; flex-wrap:wrap; margin-bottom:10px; }
.det-card {
  background: var(--surface-2);
  border: 1px solid var(--border);
  border-radius: var(--radius-sm);
  padding: 10px 16px;
  font-size: .84rem;
  min-width: 140px;
}
.det-card .label {
  font-weight: 600; text-transform: capitalize; margin-bottom:2px;
}
.det-card .conf { color: var(--text-dim); font-size:.79rem; }

/* Manual mode banner */
.manual-banner {
  background: var(--surface-3);
  border: 1px solid var(--primary);
  border-radius: var(--radius-sm);
  padding: 12px 18px;
  margin-bottom: 16px;
  font-size: .86rem;
  display: none;
}
.manual-banner.active { display:block; }
.manual-banner .step-num { color:var(--primary-h); font-weight:700; }

.click-marker {
  position: absolute;
  width: 20px; height: 20px; border-radius: 50%;
  border: 2px solid #fff;
  transform: translate(-50%, -50%);
  pointer-events: none;
  z-index: 10;
  box-shadow: 0 0 8px rgba(0,0,0,.7);
}

/* ================================================================
   PIPELINE PROGRESS  (enhanced with sub-steps)
   ================================================================ */
.progress-outer {
  width: 100%;
  height: 8px;
  background: var(--surface-3);
  border-radius: 6px;
  overflow: hidden;
  margin: 18px 0 16px;
}
.progress-inner {
  height: 100%;
  background: linear-gradient(90deg, var(--primary), #a78bfa, var(--success));
  border-radius: 6px;
  width: 0%;
  transition: width .5s ease;
}
.progress-pct {
  font-size: .82rem;
  font-weight: 600;
  color: var(--text-dim);
  text-align: right;
  margin-bottom: 4px;
}

.sub-steps {
  list-style: none;
  margin: 16px 0 0;
  padding: 0;
}
.sub-step {
  display: flex;
  align-items: center;
  gap: 10px;
  padding: 9px 0;
  font-size: .86rem;
  border-bottom: 1px solid rgba(42,42,72,.5);
}
.sub-step:last-child { border-bottom: none; }
.sub-step-icon {
  width: 22px; height: 22px;
  display: flex; align-items: center; justify-content: center;
  flex-shrink: 0;
  border-radius: 50%;
  font-size: .7rem;
}
.sub-step-icon.pending  { background: var(--surface-3); color: var(--text-muted); }
.sub-step-icon.running  { background: var(--primary-bg); border: 2px solid var(--primary); color: var(--primary); }
.sub-step-icon.complete { background: var(--success); color: #fff; }
.sub-step-icon.error    { background: var(--danger); color: #fff; }
.sub-step-label { flex:1; color: var(--text); }
.sub-step.pending .sub-step-label { color: var(--text-muted); }
.sub-step-detail {
  font-size: .78rem;
  color: var(--text-dim);
  white-space: nowrap;
}

.status-msg {
  color: var(--text-dim);
  font-size: .86rem;
  min-height: 1.3em;
  margin-top: 8px;
}

/* ================================================================
   FORM ELEMENTS  (Generate / Validate)
   ================================================================ */
.form-group { margin-bottom: 18px; }
.form-label {
  display: block;
  font-size: .82rem;
  font-weight: 600;
  color: var(--text-dim);
  margin-bottom: 6px;
  text-transform: uppercase;
  letter-spacing: .03em;
}
.form-textarea, .form-input {
  width: 100%;
  background: var(--surface-2);
  border: 1px solid var(--border);
  border-radius: var(--radius-sm);
  padding: 10px 14px;
  color: var(--text);
  font-size: .88rem;
  font-family: inherit;
  outline: none;
  transition: border-color .2s;
  resize: vertical;
}
.form-textarea:focus, .form-input:focus { border-color: var(--primary); }
.form-textarea::placeholder, .form-input::placeholder { color: var(--text-muted); }

.server-status {
  display: inline-flex;
  align-items: center;
  gap: 6px;
  font-size: .82rem;
  padding: 4px 12px;
  border-radius: 20px;
}
.server-status.ok {
  background: var(--success-bg);
  color: var(--success);
  border: 1px solid rgba(34,197,94,.2);
}
.server-status.err {
  background: rgba(239,68,68,.08);
  color: var(--danger);
  border: 1px solid rgba(239,68,68,.2);
}
.server-status.warn {
  background: rgba(234,179,8,.08);
  color: #eab308;
  border: 1px solid rgba(234,179,8,.2);
}

/* ================================================================
   IoU BADGE & CHART
   ================================================================ */
.section-heading {
  font-size: .92rem;
  font-weight: 600;
  color: var(--text);
  margin: 24px 0 12px;
  padding-bottom: 8px;
  border-bottom: 1px solid var(--border);
}

.iou-badge {
  display: inline-flex;
  align-items: center;
  gap: 8px;
  padding: 8px 20px;
  border-radius: 20px;
  font-size: 1rem;
  font-weight: 700;
  letter-spacing: .04em;
}
.iou-badge.pass {
  background: var(--success-bg);
  color: var(--success);
  border: 1px solid rgba(34,197,94,.3);
}
.iou-badge.fail {
  background: rgba(239,68,68,.08);
  color: var(--danger);
  border: 1px solid rgba(239,68,68,.3);
}

.iou-chart-wrap {
  background: var(--surface-2);
  border: 1px solid var(--border);
  border-radius: var(--radius-sm);
  padding: 16px;
  margin-top: 16px;
  overflow-x: auto;
}
.iou-chart-wrap canvas {
  width: 100%;
  height: 160px;
  display: block;
}

/* ================================================================
   RESULTS — COMPARISON VIEWER  (side-by-side)
   ================================================================ */
.results-header {
  display: flex;
  align-items: center;
  justify-content: space-between;
  margin-bottom: 16px;
  flex-wrap: wrap;
  gap: 10px;
}
.results-badge {
  display: inline-flex;
  align-items: center;
  gap: 6px;
  background: var(--success-bg);
  border: 1px solid rgba(34,197,94,.2);
  border-radius: 20px;
  padding: 5px 14px;
  font-size: .82rem;
  font-weight: 600;
  color: var(--success);
}

.comparison {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 14px;
  margin-bottom: 4px;
}
@media (max-width: 700px) {
  .comparison { grid-template-columns: 1fr; }
}

.comp-panel {
  background: var(--surface-2);
  border-radius: var(--radius);
  overflow: hidden;
  border: 1px solid var(--border);
}
.comp-panel-head {
  padding: 8px 14px;
  border-bottom: 1px solid var(--border);
  display: flex;
  align-items: center;
  justify-content: space-between;
  min-height: 40px;
}
.comp-panel-title {
  font-size: .82rem;
  font-weight: 600;
  color: var(--text-dim);
  text-transform: uppercase;
  letter-spacing: .03em;
}
.comp-tabs {
  display: flex;
  gap: 3px;
}
.comp-tab {
  padding: 4px 11px;
  border: none;
  border-radius: 6px;
  background: transparent;
  color: var(--text-muted);
  font-size: .78rem;
  font-weight: 500;
  cursor: pointer;
  transition: all .15s;
}
.comp-tab.active { background: var(--primary); color: #fff; }
.comp-tab:hover:not(.active) { background: var(--surface-3); color: var(--text); }

.comp-panel-body {
  position: relative;
  line-height: 0;
  background: #000;
  min-height: 120px;
  display: flex;
  align-items: center;
  justify-content: center;
}
.comp-panel-body img,
.comp-panel-body canvas {
  width: 100%;
  height: auto;
  display: block;
}
.comp-panel-body video {
  width: 100%;
  height: auto;
  display: block;
}
.comp-panel-body .placeholder {
  color: var(--text-muted);
  font-size: .82rem;
  line-height: 1.4;
  padding: 40px 20px;
  text-align: center;
}

/* Playback controls strip */
.playback {
  display: flex;
  align-items: center;
  gap: 12px;
  padding: 14px 0 8px;
}
.btn-play {
  width: 34px; height: 34px;
  border-radius: 50%;
  border: none;
  background: var(--primary);
  color: #fff;
  font-size: .85rem;
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
  flex-shrink: 0;
  transition: background .2s;
}
.btn-play:hover { background: var(--primary-h); }

.frame-slider {
  flex: 1;
  -webkit-appearance: none;
  appearance: none;
  height: 5px;
  background: var(--surface-3);
  border-radius: 3px;
  outline: none;
  cursor: pointer;
}
.frame-slider::-webkit-slider-thumb {
  -webkit-appearance: none;
  width: 15px; height: 15px;
  border-radius: 50%;
  background: var(--primary);
  cursor: pointer;
  border: 2px solid #fff;
  box-shadow: 0 0 4px rgba(0,0,0,.3);
}
.frame-slider::-moz-range-thumb {
  width: 15px; height: 15px;
  border-radius: 50%;
  background: var(--primary);
  cursor: pointer;
  border: 2px solid #fff;
  box-shadow: 0 0 4px rgba(0,0,0,.3);
}
.frame-info {
  font-size: .78rem;
  color: var(--text-dim);
  white-space: nowrap;
  min-width: 160px;
  text-align: right;
  font-variant-numeric: tabular-nums;
}

/* Results summary grid */
.summary-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
  gap: 12px;
  margin-top: 20px;
}
.summary-card {
  background: var(--surface-2);
  border: 1px solid var(--border);
  border-radius: var(--radius-sm);
  padding: 14px 18px;
}
.summary-card .sc-label {
  font-size: .74rem;
  color: var(--text-muted);
  text-transform: uppercase;
  letter-spacing: .04em;
  margin-bottom: 4px;
}
.summary-card .sc-value {
  font-size: 1.15rem;
  font-weight: 700;
  color: var(--text);
}
.summary-card .sc-detail {
  font-size: .78rem;
  color: var(--text-dim);
  margin-top: 2px;
}

/* ================================================================
   SPINNER
   ================================================================ */
.spinner {
  display: inline-block;
  width: 16px; height: 16px;
  border: 2.5px solid rgba(255,255,255,.2);
  border-top-color: #fff;
  border-radius: 50%;
  animation: spin .6s linear infinite;
  vertical-align: middle;
}
.spinner-sm { width:12px; height:12px; border-width:2px; }
@keyframes spin { to { transform:rotate(360deg); } }

/* ================================================================
   ERROR TOAST
   ================================================================ */
.toast {
  position: fixed;
  bottom: 24px;
  left: 50%;
  transform: translateX(-50%) translateY(80px);
  background: var(--danger);
  color: #fff;
  padding: 12px 24px;
  border-radius: var(--radius-sm);
  font-size: .86rem;
  box-shadow: var(--shadow-lg);
  opacity: 0;
  transition: opacity .3s, transform .3s;
  z-index: 999;
  max-width: 90%;
  text-align: center;
}
.toast.show {
  opacity: 1;
  transform: translateX(-50%) translateY(0);
}
</style>
</head>

<body>

<!-- ============================================================
     HEADER + STEPPER (6 steps)
     ============================================================ -->
<div class="header">
  <h1>Skate Physics Preserver</h1>
  <p>Upload &middot; Detect &middot; Extract &middot; Generate &middot; Validate &middot; Results</p>

  <div class="stepper-wrap">
    <div class="stepper" id="stepper">
      <div class="stepper-step active" data-idx="0">
        <div class="stepper-circle" id="sc-0">1</div>
        <div class="stepper-label">Upload</div>
      </div>
      <div class="stepper-step" data-idx="1">
        <div class="stepper-circle" id="sc-1">2</div>
        <div class="stepper-label">Detect</div>
      </div>
      <div class="stepper-step" data-idx="2">
        <div class="stepper-circle" id="sc-2">3</div>
        <div class="stepper-label">Extract</div>
      </div>
      <div class="stepper-step" data-idx="3">
        <div class="stepper-circle" id="sc-3">4</div>
        <div class="stepper-label">Generate</div>
      </div>
      <div class="stepper-step" data-idx="4">
        <div class="stepper-circle" id="sc-4">5</div>
        <div class="stepper-label">Validate</div>
      </div>
      <div class="stepper-step" data-idx="5">
        <div class="stepper-circle" id="sc-5">6</div>
        <div class="stepper-label">Results</div>
      </div>
    </div>
  </div>
</div>

<div class="container">

  <!-- ========================================================
       STEP 1 : Upload / load video
       ======================================================== -->
  <div id="step-upload" class="step active">
    <div class="step-title">Load Video</div>
    <div class="step-desc">
      Upload an .mp4 file or paste a YouTube URL.  The first frame will be
      used for automatic skater + skateboard detection.
    </div>

    <div class="upload-zone" id="drop-zone">
      <div class="icon">&#128249;</div>
      <p>Drag &amp; drop a video here, or <strong>click to browse</strong></p>
      <input type="file" id="file-input" accept="video/*" hidden>
    </div>

    <div class="or-divider">or</div>

    <div class="url-row">
      <input type="text" id="yt-url" value="https://www.youtube.com/shorts/wPpXDBMk8-E" placeholder="https://www.youtube.com/watch?v=...">
      <button class="btn btn-primary" id="btn-load-url">Load URL</button>
    </div>

    <div id="upload-status" class="status-msg" style="margin-top:12px;"></div>

    <div class="video-info" id="video-info">
      <span class="vi-name" id="vi-name"></span>
      <span class="vi-meta" id="vi-meta"></span>
    </div>
  </div>

  <!-- ========================================================
       STEP 2 : Detection & validation
       ======================================================== -->
  <div id="step-detect" class="step">
    <div class="step-title">Validate Detections</div>
    <div class="step-desc" id="detect-desc">
      SAM 2.1 masks overlaid on frame 0.  Confirm both the <strong
      style="color:var(--skater)">skater</strong> and
      <strong style="color:var(--skateboard)">skateboard</strong>
      are correctly segmented.
    </div>

    <div class="legend">
      <div class="legend-item"><span class="legend-dot skater"></span> Skater</div>
      <div class="legend-item"><span class="legend-dot skateboard"></span> Skateboard</div>
    </div>

    <div class="preview-wrap" id="preview-wrap">
      <img id="preview-img" src="" alt="Detection preview">
    </div>

    <div id="det-cards" class="det-cards"></div>

    <!-- manual mode -->
    <div class="manual-banner" id="manual-banner">
      <span class="step-num" id="manual-step-text">Step 1/2</span>
      &mdash; <span id="manual-instruction">Click on the <strong>skater</strong> in the image above.</span>
    </div>

    <div class="btn-row">
      <button class="btn btn-success" id="btn-approve">Approve &amp; Run Pipeline</button>
      <button class="btn btn-warning" id="btn-manual">Manual Select</button>
      <button class="btn btn-outline" id="btn-redetect">Re-detect</button>
      <button class="btn btn-outline" id="btn-back-upload">Back</button>
    </div>
  </div>

  <!-- ========================================================
       STEP 3 : Pipeline running  (Stage 1 extraction)
       ======================================================== -->
  <div id="step-pipeline" class="step">
    <div class="step-title">Extracting Physics</div>
    <div class="step-desc">
      Running DWPose skeleton extraction and SAM 2.1 mask propagation.
      This may take a few minutes depending on video length.
    </div>

    <div class="progress-pct" id="prog-pct">0%</div>
    <div class="progress-outer">
      <div class="progress-inner" id="prog-bar"></div>
    </div>

    <ul class="sub-steps" id="sub-steps"></ul>

    <div class="status-msg" id="pipeline-msg">Initialising ...</div>
  </div>

  <!-- ========================================================
       STEP 4 : Generate Reskin  (Stage 2)
       ======================================================== -->
  <div id="step-generate" class="step">
    <div class="step-title">Generate Reskin</div>
    <div class="step-desc">
      Extraction complete. Enter your creative prompt and generate a reskinned video via ComfyUI.
    </div>

    <!-- Extraction summary cards -->
    <div class="summary-grid" id="gen-summary-grid" style="margin-bottom:24px;"></div>

    <!-- ComfyUI Server -->
    <div class="form-group">
      <label class="form-label">ComfyUI Server</label>
      <div class="url-row">
        <input type="text" id="comfyui-server" value="127.0.0.1:8188" placeholder="127.0.0.1:8188">
        <button class="btn btn-outline btn-sm" id="btn-check-comfyui">Check Connection</button>
      </div>
      <div id="comfyui-status" class="status-msg" style="margin-top:6px;"></div>
      <small style="color:var(--text-muted); display:block; margin-top:4px;">
        ComfyUI will be started automatically when you click Generate if a path is configured.
      </small>
    </div>

    <!-- Positive Prompt -->
    <div class="form-group">
      <label class="form-label">Positive Prompt</label>
      <textarea id="positive-prompt" class="form-textarea" rows="3"
        placeholder="e.g. cyberpunk samurai riding a neon hoverboard, cinematic lighting"></textarea>
    </div>

    <!-- Negative Prompt -->
    <div class="form-group">
      <label class="form-label">Negative Prompt</label>
      <textarea id="negative-prompt" class="form-textarea" rows="2">blurry, distorted, deformed, low quality</textarea>
    </div>

    <!-- Generation Progress (hidden until running) -->
    <div id="gen-progress-wrap" style="display:none;">
      <div class="progress-pct" id="gen-prog-pct">0%</div>
      <div class="progress-outer">
        <div class="progress-inner" id="gen-prog-bar"></div>
      </div>
      <ul class="sub-steps" id="gen-sub-steps"></ul>
      <div class="status-msg" id="gen-msg">Starting generation...</div>
    </div>

    <div class="btn-row" id="gen-btn-row">
      <button class="btn btn-primary" id="btn-generate">Generate Reskin</button>
      <button class="btn btn-outline" id="btn-skip-generate">Skip to Results</button>
    </div>
  </div>

  <!-- ========================================================
       STEP 5 : Validate IoU  (Stage 3)
       ======================================================== -->
  <div id="step-validate" class="step">
    <div class="step-title">Validate Physics Preservation</div>
    <div class="step-desc">
      Re-track the generated object in the output video with SAM 2.1, then measure
      frame-by-frame IoU against original masks. Target: IoU &ge; 0.90 on all frames.
    </div>

    <!-- Config -->
    <div class="form-group">
      <label class="form-label">IoU Threshold</label>
      <input type="number" id="iou-threshold" class="form-input" value="0.90"
             step="0.01" min="0" max="1" style="width:120px;">
    </div>

    <!-- Generated video info / upload -->
    <div class="form-group">
      <label class="form-label">Generated Video</label>
      <div id="val-video-name" class="status-msg" style="margin-bottom:6px;"></div>
      <label class="btn btn-outline btn-sm" style="cursor:pointer;">
        Upload Different Video
        <input type="file" id="val-video-input" accept="video/*" hidden>
      </label>
    </div>

    <!-- Validation Progress (hidden until running) -->
    <div id="val-progress-wrap" style="display:none;">
      <div class="progress-pct" id="val-prog-pct">0%</div>
      <div class="progress-outer">
        <div class="progress-inner" id="val-prog-bar"></div>
      </div>
      <ul class="sub-steps" id="val-sub-steps"></ul>
      <div class="status-msg" id="val-msg">Starting validation...</div>
    </div>

    <!-- IoU Results (shown when complete) -->
    <div id="val-results-wrap" style="display:none;">
      <div style="margin:16px 0;">
        <span class="iou-badge" id="val-iou-badge">PENDING</span>
      </div>
      <div class="summary-grid" id="val-iou-grid"></div>
      <div class="iou-chart-wrap">
        <canvas id="val-iou-chart"></canvas>
      </div>
    </div>

    <div class="btn-row" id="val-btn-row">
      <button class="btn btn-success" id="btn-validate">Run Validation</button>
      <button class="btn btn-outline" id="btn-back-generate">Back</button>
      <button class="btn btn-outline" id="btn-skip-validate">Skip to Results</button>
    </div>
  </div>

  <!-- ========================================================
       STEP 6 : Results — full view
       ======================================================== -->
  <div id="step-results" class="step">
    <div class="results-header">
      <div>
        <div class="step-title">Results</div>
        <div class="step-desc" style="margin-bottom:0;" id="results-summary-text">
          Pipeline complete. Use the viewers below to inspect outputs.
        </div>
      </div>
      <div class="results-badge" id="results-badge">
        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3"><polyline points="20 6 9 17 4 12"/></svg>
        Complete
      </div>
    </div>

    <!-- IoU Report (shown if validation was run) -->
    <div id="results-iou-section" style="display:none;">
      <div class="section-heading">IoU Validation Report</div>
      <div style="margin-bottom:12px;">
        <span class="iou-badge" id="results-iou-badge">PENDING</span>
      </div>
      <div class="summary-grid" id="results-iou-grid"></div>
      <div class="iou-chart-wrap">
        <canvas id="results-iou-chart"></canvas>
      </div>
    </div>

    <!-- Generated Video Comparison (shown if generation was done) -->
    <div id="results-gen-section" style="display:none;">
      <div class="section-heading">Original vs Generated</div>
      <div class="comparison">
        <div class="comp-panel">
          <div class="comp-panel-head"><span class="comp-panel-title">Original</span></div>
          <div class="comp-panel-body">
            <video id="results-orig-video" controls muted></video>
          </div>
        </div>
        <div class="comp-panel">
          <div class="comp-panel-head"><span class="comp-panel-title">Generated</span></div>
          <div class="comp-panel-body">
            <video id="results-gen-video" controls muted></video>
          </div>
        </div>
      </div>
    </div>

    <!-- Frame Analysis (extraction outputs) -->
    <div class="section-heading">Frame Analysis</div>
    <div class="comparison">
      <div class="comp-panel">
        <div class="comp-panel-head">
          <span class="comp-panel-title">Original</span>
        </div>
        <div class="comp-panel-body" id="comp-left-body">
          <div class="placeholder">Loading frames ...</div>
        </div>
      </div>
      <div class="comp-panel">
        <div class="comp-panel-head">
          <span class="comp-panel-title" id="comp-right-title">Output</span>
          <div class="comp-tabs" id="comp-tabs"></div>
        </div>
        <div class="comp-panel-body" id="comp-right-body">
          <div class="placeholder">Select a view above</div>
        </div>
      </div>
    </div>

    <!-- Playback controls -->
    <div class="playback">
      <button class="btn-play" id="btn-play" title="Play / Pause">&#9654;</button>
      <input type="range" class="frame-slider" id="frame-slider" min="0" max="0" value="0">
      <span class="frame-info" id="frame-info">Frame 0 / 0</span>
    </div>

    <!-- Summary cards -->
    <div class="summary-grid" id="summary-grid"></div>

    <div class="btn-row" style="justify-content:center; margin-top:24px;">
      <button class="btn btn-primary" id="btn-new">Process Another Video</button>
    </div>
  </div>

</div><!-- /.container -->

<!-- Error toast -->
<div class="toast" id="toast"></div>

<script>
/* =============================================================
   GLOBALS
   ============================================================= */
const $ = (sel) => document.querySelector(sel);
const $$ = (sel) => document.querySelectorAll(sel);

/* ---- Stepper management (6 steps) ---- */
const STEP_NAMES = ['upload', 'detect', 'pipeline', 'generate', 'validate', 'results'];
let currentStepIdx = 0;

const stepEls = {
  upload:   $('#step-upload'),
  detect:   $('#step-detect'),
  pipeline: $('#step-pipeline'),
  generate: $('#step-generate'),
  validate: $('#step-validate'),
  results:  $('#step-results'),
};

function showStep(name) {
  const idx = STEP_NAMES.indexOf(name);
  if (idx === -1) return;
  currentStepIdx = idx;

  Object.values(stepEls).forEach(s => s.classList.remove('active'));
  stepEls[name].classList.add('active');
  updateStepper();
  window.scrollTo({top: 0, behavior: 'smooth'});

  // Auto-check ComfyUI when entering the Generate step
  if (name === 'generate') {
    checkComfyUI();
  }
}

function updateStepper() {
  const steps = $$('#stepper .stepper-step');
  steps.forEach((el, i) => {
    el.classList.remove('active', 'complete');
    const circle = el.querySelector('.stepper-circle');
    if (i < currentStepIdx) {
      el.classList.add('complete');
      circle.innerHTML = '<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3"><polyline points="20 6 9 17 4 12"/></svg>';
    } else if (i === currentStepIdx) {
      el.classList.add('active');
      circle.textContent = i + 1;
    } else {
      circle.textContent = i + 1;
    }
  });
  positionStepperLines();
}

function positionStepperLines() {
  $$('.stepper-line').forEach(l => l.remove());
  const steps = $$('#stepper .stepper-step');
  const stepper = $('#stepper');
  for (let i = 0; i < steps.length - 1; i++) {
    const c1 = steps[i].querySelector('.stepper-circle');
    const c2 = steps[i + 1].querySelector('.stepper-circle');
    const r1 = c1.getBoundingClientRect();
    const r2 = c2.getBoundingClientRect();
    const sr = stepper.getBoundingClientRect();
    const line = document.createElement('div');
    line.className = 'stepper-line' + (i < currentStepIdx ? ' done' : '');
    line.style.left = (r1.right - sr.left) + 'px';
    line.style.width = (r2.left - r1.right) + 'px';
    stepper.appendChild(line);
  }
}
window.addEventListener('resize', positionStepperLines);
requestAnimationFrame(positionStepperLines);

/* ---- Toast ---- */
let _toastTimer;
function toast(msg, ms = 5000) {
  const t = $('#toast');
  t.textContent = msg;
  t.classList.add('show');
  clearTimeout(_toastTimer);
  _toastTimer = setTimeout(() => t.classList.remove('show'), ms);
}

/* =============================================================
   STEP 1 — Upload
   ============================================================= */
const dropZone  = $('#drop-zone');
const fileInput = $('#file-input');
const ytInput   = $('#yt-url');
const uploadSt  = $('#upload-status');

dropZone.addEventListener('click', () => fileInput.click());
dropZone.addEventListener('dragover', e => { e.preventDefault(); dropZone.classList.add('drag-over'); });
dropZone.addEventListener('dragleave', () => dropZone.classList.remove('drag-over'));
dropZone.addEventListener('drop', e => {
  e.preventDefault();
  dropZone.classList.remove('drag-over');
  if (e.dataTransfer.files.length) loadFile(e.dataTransfer.files[0]);
});
fileInput.addEventListener('change', () => {
  if (fileInput.files.length) loadFile(fileInput.files[0]);
});
$('#btn-load-url').addEventListener('click', () => {
  const url = ytInput.value.trim();
  if (!url) return;
  loadUrl(url);
});

async function loadFile(file) {
  uploadSt.innerHTML = '<span class="spinner"></span> Uploading & reading first frame ...';
  const fd = new FormData();
  fd.append('video', file);
  try {
    const r = await fetch('/api/load', {method:'POST', body: fd});
    const j = await r.json();
    if (!r.ok) throw new Error(j.error || 'Upload failed');
    onVideoLoaded(j, file.name);
  } catch(e) { toast(e.message); uploadSt.textContent = ''; }
}

async function loadUrl(url) {
  uploadSt.innerHTML = '<span class="spinner"></span> Downloading video ...';
  const fd = new FormData();
  fd.append('url', url);
  try {
    const r = await fetch('/api/load', {method:'POST', body: fd});
    const j = await r.json();
    if (!r.ok) throw new Error(j.error || 'Load failed');
    onVideoLoaded(j, j.video_path || 'YouTube video');
  } catch(e) { toast(e.message); uploadSt.textContent = ''; }
}

function onVideoLoaded(data, displayName) {
  uploadSt.textContent = '';
  window._frameB64   = data.frame;
  window._frameW     = data.width;
  window._frameH     = data.height;
  window._fps        = data.fps || 30;
  window._frameCount = data.frame_count || 0;
  window._duration   = data.duration || 0;

  const vi = $('#video-info');
  vi.classList.add('show');
  $('#vi-name').textContent = displayName || 'video';
  const dur = window._duration;
  const durStr = dur > 0 ? `${dur.toFixed(1)}s` : '';
  const fpsStr = window._fps > 0 ? `${window._fps.toFixed(1)} fps` : '';
  const dimStr = `${data.width}x${data.height}`;
  $('#vi-meta').textContent = [dimStr, fpsStr, durStr].filter(Boolean).join(' · ');

  runAutoDetect();
}

/* =============================================================
   STEP 2 — Detection
   ============================================================= */

async function runAutoDetect() {
  showStep('detect');
  $('#preview-img').src = 'data:image/jpeg;base64,' + window._frameB64;
  $('#det-cards').innerHTML = '';
  $('#detect-desc').textContent = 'Running YOLO + SAM auto-detection ...';
  disableDetectBtns(true);

  try {
    const r = await fetch('/api/detect', {method:'POST'});
    const j = await r.json();
    if (!r.ok) throw new Error(j.error || 'Detection failed');
    onDetected(j);
  } catch(e) {
    toast(e.message);
    $('#detect-desc').textContent = 'Detection failed. Try manual mode.';
    disableDetectBtns(false);
  }
}

function onDetected(data) {
  if (data.overlay) {
    $('#preview-img').src = 'data:image/jpeg;base64,' + data.overlay;
  }
  const cards = $('#det-cards');
  cards.innerHTML = '';
  (data.detections || []).forEach(d => {
    const c = document.createElement('div');
    c.className = 'det-card';
    c.innerHTML = `<div class="label" style="color:var(--${d.label})">${d.label}</div>
                   <div class="conf">${(d.confidence*100).toFixed(1)}% confidence</div>
                   <div class="conf">bbox: [${d.bbox.join(', ')}]</div>`;
    cards.appendChild(c);
  });
  const desc = $('#detect-desc');
  if (data.detections && data.detections.length >= 2) {
    desc.innerHTML = 'Both <strong style="color:var(--skater)">skater</strong> and ' +
      '<strong style="color:var(--skateboard)">skateboard</strong> detected. ' +
      'Review the masks and approve to run the full pipeline.';
  } else if (data.detections && data.detections.length === 1) {
    const found = data.detections[0].label;
    const missing = found === 'skater' ? 'skateboard' : 'skater';
    desc.innerHTML = `Only <strong>${found}</strong> detected. ` +
      `Use <em>Manual Select</em> to click on the <strong>${missing}</strong>.`;
  } else {
    desc.textContent = data.message || 'No objects detected. Use manual mode.';
  }
  disableDetectBtns(false);
  exitManualMode();
}

function disableDetectBtns(disabled) {
  ['#btn-approve','#btn-manual','#btn-redetect','#btn-back-upload'].forEach(s => {
    $(s).disabled = disabled;
  });
}

/* Approve */
$('#btn-approve').addEventListener('click', async () => {
  $('#btn-approve').disabled = true;
  try {
    const r = await fetch('/api/approve', {method:'POST'});
    const j = await r.json();
    if (!r.ok) throw new Error(j.error || 'Could not start pipeline');
    showStep('pipeline');
    pollPipeline();
  } catch(e) {
    toast(e.message);
    $('#btn-approve').disabled = false;
  }
});

$('#btn-redetect').addEventListener('click', runAutoDetect);
$('#btn-back-upload').addEventListener('click', () => {
  exitManualMode();
  showStep('upload');
});

/* ----- Manual mode ----- */
let manualMode   = false;
let manualPoints = [];
let manualStep   = 0;
const MANUAL_ORDER = ['skater', 'skateboard'];

$('#btn-manual').addEventListener('click', () => enterManualMode());

function enterManualMode() {
  manualMode = true;
  manualStep = 0;
  manualPoints = [];
  clearMarkers();
  $('#preview-img').src = 'data:image/jpeg;base64,' + window._frameB64;
  $('#preview-wrap').classList.add('clickable');
  $('#manual-banner').classList.add('active');
  updateManualInstruction();
  $('#btn-approve').disabled = true;
  $('#btn-manual').textContent = 'Cancel Manual';
  $('#btn-manual').onclick = exitManualMode;
}

function exitManualMode() {
  manualMode = false;
  manualPoints = [];
  manualStep = 0;
  clearMarkers();
  $('#preview-wrap').classList.remove('clickable');
  $('#manual-banner').classList.remove('active');
  $('#btn-manual').textContent = 'Manual Select';
  $('#btn-manual').onclick = () => enterManualMode();
}

function updateManualInstruction() {
  const label = MANUAL_ORDER[manualStep];
  const color = label === 'skater' ? 'var(--skater)' : 'var(--skateboard)';
  $('#manual-step-text').textContent = `Step ${manualStep+1}/2`;
  $('#manual-instruction').innerHTML =
    `Click on the <strong style="color:${color}">${label}</strong> in the image above.`;
}

$('#preview-wrap').addEventListener('click', (e) => {
  if (!manualMode) return;
  if (manualStep >= 2) return;

  const img  = $('#preview-img');
  const rect = img.getBoundingClientRect();
  const scX  = window._frameW / rect.width;
  const scY  = window._frameH / rect.height;
  const x    = Math.round((e.clientX - rect.left) * scX);
  const y    = Math.round((e.clientY - rect.top)  * scY);
  const label = MANUAL_ORDER[manualStep];

  manualPoints.push({x, y, label});
  addMarker(e.clientX - rect.left, e.clientY - rect.top, label);

  manualStep++;
  if (manualStep < 2) {
    updateManualInstruction();
  } else {
    $('#manual-banner').classList.remove('active');
    submitManualPoints();
  }
});

function addMarker(px, py, label) {
  const wrap = $('#preview-wrap');
  const m = document.createElement('div');
  m.className = 'click-marker';
  m.style.left = px + 'px';
  m.style.top  = py + 'px';
  m.style.background = label === 'skater' ? 'var(--skater)' : 'var(--skateboard)';
  wrap.appendChild(m);
}

function clearMarkers() {
  $$('.click-marker').forEach(m => m.remove());
}

async function submitManualPoints() {
  disableDetectBtns(true);
  $('#detect-desc').textContent = 'Running SAM segmentation on your points ...';
  try {
    const r = await fetch('/api/refine', {
      method: 'POST',
      headers: {'Content-Type':'application/json'},
      body: JSON.stringify({points: manualPoints}),
    });
    const j = await r.json();
    if (!r.ok) throw new Error(j.error || 'Refinement failed');
    exitManualMode();
    onDetected(j);
  } catch(e) {
    toast(e.message);
    disableDetectBtns(false);
  }
}

/* =============================================================
   STEP 3 — Pipeline progress (Stage 1 extraction)
   ============================================================= */
let _pollTimer;

function renderSubSteps(subSteps, targetEl) {
  const ul = targetEl || $('#sub-steps');
  ul.innerHTML = '';
  if (!subSteps || !subSteps.length) return;

  subSteps.forEach(ss => {
    const li = document.createElement('li');
    li.className = 'sub-step ' + ss.status;

    let iconContent = '';
    if (ss.status === 'complete') iconContent = '<svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3"><polyline points="20 6 9 17 4 12"/></svg>';
    else if (ss.status === 'running') iconContent = '<span class="spinner spinner-sm"></span>';
    else if (ss.status === 'error') iconContent = '!';
    else iconContent = '';

    li.innerHTML = `
      <div class="sub-step-icon ${ss.status}">${iconContent}</div>
      <span class="sub-step-label">${ss.label}</span>
      <span class="sub-step-detail">${ss.detail || ''}</span>
    `;
    ul.appendChild(li);
  });
}

function pollPipeline() {
  clearInterval(_pollTimer);
  _pollTimer = setInterval(async () => {
    try {
      const r = await fetch('/api/status');
      const j = await r.json();

      $('#prog-bar').style.width = j.progress + '%';
      $('#prog-pct').textContent = j.progress + '%';
      $('#pipeline-msg').textContent = j.message || '';
      renderSubSteps(j.sub_steps, $('#sub-steps'));

      if (j.status === 'complete') {
        clearInterval(_pollTimer);
        onPipelineComplete(j);
      } else if (j.status === 'error') {
        clearInterval(_pollTimer);
        toast(j.error || 'Pipeline error');
        $('#pipeline-msg').textContent = 'Error: ' + (j.error || 'Unknown');
      }
    } catch(e) { /* ignore transient fetch errors */ }
  }, 1200);
}

/* =============================================================
   Pipeline complete → transition to Generate step
   ============================================================= */
let compState = {
  outputs: {},
  frameCount: 0,
  fps: 30,
  duration: 0,
  currentFrame: 0,
  activeView: 'pose_skater',
  playing: false,
  playTimer: null,
  imageCache: {},
};

async function onPipelineComplete(statusData) {
  // Fetch detailed output info and store in compState
  try {
    const r = await fetch('/api/outputs/info');
    const info = await r.json();
    compState.outputs = info.outputs || {};
    compState.frameCount = info.frame_count || statusData.frame_count || 0;
    compState.fps = info.fps || statusData.fps || 30;
    compState.duration = info.duration || statusData.duration || 0;
  } catch(e) {
    compState.frameCount = statusData.frame_count || 0;
    compState.fps = statusData.fps || 30;
    compState.duration = statusData.duration || 0;
  }

  // Build extraction summary in the Generate step
  buildGenSummary(statusData);

  // Go to Generate step
  showStep('generate');
}

function buildGenSummary(data) {
  const grid = $('#gen-summary-grid');
  grid.innerHTML = '';
  const cards = [
    {label: 'Frames Extracted', value: compState.frameCount, detail: `${compState.fps.toFixed(1)} fps`},
    {label: 'Duration', value: compState.duration.toFixed(1) + 's', detail: ''},
  ];
  if (compState.outputs['pose_skater']) {
    cards.push({label: 'Pose Frames', value: compState.outputs['pose_skater'].count, detail: 'pose_skater/'});
  }
  if (compState.outputs['mask_skateboard']) {
    cards.push({label: 'Board Masks', value: compState.outputs['mask_skateboard'].count, detail: 'mask_skateboard/'});
  }
  if (compState.outputs['mask_skater']) {
    cards.push({label: 'Skater Masks', value: compState.outputs['mask_skater'].count, detail: 'mask_skater/'});
  }
  cards.forEach(c => {
    const div = document.createElement('div');
    div.className = 'summary-card';
    div.innerHTML = `
      <div class="sc-label">${c.label}</div>
      <div class="sc-value">${c.value}</div>
      ${c.detail ? '<div class="sc-detail">' + c.detail + '</div>' : ''}
    `;
    grid.appendChild(div);
  });
}

/* =============================================================
   STEP 4 — Generate Reskin  (Stage 2)
   ============================================================= */

$('#btn-check-comfyui').addEventListener('click', checkComfyUI);
$('#btn-generate').addEventListener('click', startGeneration);
$('#btn-skip-generate').addEventListener('click', () => {
  showStep('results');
  showResults();
});

async function checkComfyUI() {
  const server = $('#comfyui-server').value.trim();
  if (!server) return;
  const statusEl = $('#comfyui-status');
  statusEl.innerHTML = '<span class="spinner spinner-sm"></span> Checking...';

  try {
    const r = await fetch('/api/comfyui/check', {
      method: 'POST',
      headers: {'Content-Type':'application/json'},
      body: JSON.stringify({server}),
    });
    const j = await r.json();
    if (j.status === 'ok') {
      const extra = j.autostarted ? ' (auto-started)' : '';
      statusEl.innerHTML = '<span class="server-status ok">Connected' + extra + '</span>';
    } else if (j.can_autostart) {
      statusEl.innerHTML =
        '<span class="server-status warn">Not running — will auto-start when you click Generate</span>' +
        ' <button class="btn btn-outline btn-sm" onclick="startComfyUIManually()">Start Now</button>';
    } else {
      statusEl.innerHTML =
        '<span class="server-status err">Not reachable</span>' +
        '<div style="margin-top:4px;font-size:0.85em;color:var(--text-muted);">' +
        'Set <code>--comfyui-path</code> or <code>COMFYUI_PATH</code> env var to enable auto-start, ' +
        'or start ComfyUI manually.</div>';
    }
  } catch(e) {
    statusEl.innerHTML = '<span class="server-status err">Error: ' + e.message + '</span>';
  }
}

async function startComfyUIManually() {
  const statusEl = $('#comfyui-status');
  statusEl.innerHTML = '<span class="spinner spinner-sm"></span> Starting ComfyUI (this may take 30-60s)...';

  try {
    const r = await fetch('/api/comfyui/start', {
      method: 'POST',
      headers: {'Content-Type':'application/json'},
      body: JSON.stringify({}),
    });
    const j = await r.json();
    if (j.status === 'ok') {
      statusEl.innerHTML = '<span class="server-status ok">Connected (auto-started)</span>';
    } else {
      statusEl.innerHTML = '<span class="server-status err">' + (j.message || 'Failed to start') + '</span>';
    }
  } catch(e) {
    statusEl.innerHTML = '<span class="server-status err">Error: ' + e.message + '</span>';
  }
}

async function startGeneration() {
  const positivePrompt = $('#positive-prompt').value.trim();
  const negativePrompt = $('#negative-prompt').value.trim();
  const server = $('#comfyui-server').value.trim();

  if (!positivePrompt) {
    toast('Please enter a positive prompt.');
    return;
  }

  try {
    const r = await fetch('/api/generate', {
      method: 'POST',
      headers: {'Content-Type':'application/json'},
      body: JSON.stringify({
        positive_prompt: positivePrompt,
        negative_prompt: negativePrompt,
        server: server,
      }),
    });
    const j = await r.json();
    if (!r.ok) throw new Error(j.error || 'Failed to start generation');

    // Show progress, hide buttons
    $('#gen-progress-wrap').style.display = 'block';
    $('#gen-btn-row').style.display = 'none';
    pollGeneration();
  } catch(e) {
    toast(e.message);
  }
}

let _genPollTimer;
function pollGeneration() {
  clearInterval(_genPollTimer);
  _genPollTimer = setInterval(async () => {
    try {
      const r = await fetch('/api/generate/status');
      const j = await r.json();

      $('#gen-prog-bar').style.width = j.progress + '%';
      $('#gen-prog-pct').textContent = j.progress + '%';
      $('#gen-msg').textContent = j.message || '';
      renderSubSteps(j.sub_steps, $('#gen-sub-steps'));

      if (j.status === 'complete') {
        clearInterval(_genPollTimer);
        onGenerationComplete(j);
      } else if (j.status === 'error') {
        clearInterval(_genPollTimer);
        toast(j.error || 'Generation error');
        $('#gen-msg').textContent = 'Error: ' + (j.error || 'Unknown');
        // Re-show buttons so user can retry
        $('#gen-btn-row').style.display = 'flex';
        $('#gen-btn-row').innerHTML = `
          <button class="btn btn-primary" onclick="retryGeneration()">Retry Generation</button>
          <button class="btn btn-outline" onclick="showStep('results'); showResults();">Skip to Results</button>
        `;
      }
    } catch(e) { /* ignore */ }
  }, 2000);
}

function retryGeneration() {
  $('#gen-progress-wrap').style.display = 'none';
  $('#gen-btn-row').style.display = 'flex';
  $('#gen-btn-row').innerHTML = `
    <button class="btn btn-primary" id="btn-generate" onclick="startGeneration()">Generate Reskin</button>
    <button class="btn btn-outline" onclick="showStep('results'); showResults();">Skip to Results</button>
  `;
}

function onGenerationComplete(data) {
  $('#gen-msg').textContent = data.message || 'Generation complete!';
  // Replace buttons with proceed option
  $('#gen-btn-row').style.display = 'flex';
  $('#gen-btn-row').innerHTML = `
    <button class="btn btn-success" onclick="goToValidate()">Proceed to Validate</button>
    <button class="btn btn-outline" onclick="showStep('results'); showResults();">Skip to Results</button>
  `;
}

function goToValidate() {
  // Update the generated video name in validate step
  const valName = $('#val-video-name');
  valName.textContent = 'Using generated video from Stage 2';
  valName.style.color = 'var(--success)';
  showStep('validate');
}

/* =============================================================
   STEP 5 — Validate IoU  (Stage 3)
   ============================================================= */

$('#btn-validate').addEventListener('click', startValidation);
$('#btn-back-generate').addEventListener('click', () => showStep('generate'));
$('#btn-skip-validate').addEventListener('click', () => {
  showStep('results');
  showResults();
});

// Handle uploaded generated video
$('#val-video-input').addEventListener('change', function() {
  if (this.files.length) {
    const name = this.files[0].name;
    $('#val-video-name').textContent = 'Selected: ' + name;
    $('#val-video-name').style.color = 'var(--primary-h)';
  }
});

async function startValidation() {
  const threshold = parseFloat($('#iou-threshold').value) || 0.90;
  const fileInput = $('#val-video-input');

  const fd = new FormData();
  fd.append('threshold', threshold);

  // If user uploaded a different video, include it
  if (fileInput.files.length > 0) {
    fd.append('video', fileInput.files[0]);
  }

  try {
    const r = await fetch('/api/validate', {method: 'POST', body: fd});
    const j = await r.json();
    if (!r.ok) throw new Error(j.error || 'Failed to start validation');

    $('#val-progress-wrap').style.display = 'block';
    $('#val-btn-row').style.display = 'none';
    pollValidation();
  } catch(e) {
    toast(e.message);
  }
}

let _valPollTimer;
function pollValidation() {
  clearInterval(_valPollTimer);
  _valPollTimer = setInterval(async () => {
    try {
      const r = await fetch('/api/validate/status');
      const j = await r.json();

      $('#val-prog-bar').style.width = j.progress + '%';
      $('#val-prog-pct').textContent = j.progress + '%';
      $('#val-msg').textContent = j.message || '';
      renderSubSteps(j.sub_steps, $('#val-sub-steps'));

      if (j.status === 'complete') {
        clearInterval(_valPollTimer);
        onValidationComplete(j);
      } else if (j.status === 'error') {
        clearInterval(_valPollTimer);
        toast(j.error || 'Validation error');
        $('#val-msg').textContent = 'Error: ' + (j.error || 'Unknown');
        $('#val-btn-row').style.display = 'flex';
      }
    } catch(e) { /* ignore */ }
  }, 2000);
}

function onValidationComplete(data) {
  const results = data.results;
  if (!results) return;

  // Show results section
  $('#val-results-wrap').style.display = 'block';

  // Badge
  const badge = $('#val-iou-badge');
  if (results.passed) {
    badge.className = 'iou-badge pass';
    badge.textContent = 'PASSED';
  } else {
    badge.className = 'iou-badge fail';
    badge.textContent = 'FAILED';
  }

  // Summary cards
  buildIoUSummary(results, '#val-iou-grid');

  // Chart
  drawIoUChart('#val-iou-chart', results.all_scores || [], results.threshold);

  // Replace buttons
  $('#val-btn-row').style.display = 'flex';
  $('#val-btn-row').innerHTML = `
    <button class="btn btn-success" onclick="showStep('results'); showResults();">View Full Results</button>
    <button class="btn btn-outline" onclick="showStep('generate')">Re-generate</button>
  `;
}

function buildIoUSummary(results, gridSel) {
  const grid = $(gridSel);
  grid.innerHTML = '';
  const cards = [
    {label: 'Average IoU', value: results.avg_iou.toFixed(4), detail: ''},
    {label: 'Minimum IoU', value: results.min_iou.toFixed(4), detail: ''},
    {label: 'Maximum IoU', value: results.max_iou.toFixed(4), detail: ''},
    {label: 'Threshold', value: results.threshold.toFixed(2), detail: ''},
    {label: 'Total Frames', value: results.total_frames, detail: ''},
    {label: 'Failed Frames', value: results.failed_count, detail: results.failed_count > 0 ? 'below threshold' : 'all passed'},
  ];
  cards.forEach(c => {
    const div = document.createElement('div');
    div.className = 'summary-card';
    div.innerHTML = `
      <div class="sc-label">${c.label}</div>
      <div class="sc-value">${c.value}</div>
      ${c.detail ? '<div class="sc-detail">' + c.detail + '</div>' : ''}
    `;
    grid.appendChild(div);
  });
}

function drawIoUChart(canvasSel, scores, threshold) {
  const canvas = $(canvasSel);
  if (!canvas || !scores.length) return;

  const dpr = window.devicePixelRatio || 1;
  const w = canvas.clientWidth || 800;
  const h = canvas.clientHeight || 160;
  canvas.width = w * dpr;
  canvas.height = h * dpr;
  const ctx = canvas.getContext('2d');
  ctx.scale(dpr, dpr);

  const pad = {top: 20, right: 20, bottom: 28, left: 45};
  const plotW = w - pad.left - pad.right;
  const plotH = h - pad.top - pad.bottom;

  // Background
  ctx.clearRect(0, 0, w, h);

  // Grid lines
  ctx.strokeStyle = 'rgba(42,42,72,0.5)';
  ctx.lineWidth = 1;
  for (let v = 0; v <= 1; v += 0.25) {
    const y = pad.top + plotH * (1 - v);
    ctx.beginPath();
    ctx.moveTo(pad.left, y);
    ctx.lineTo(w - pad.right, y);
    ctx.stroke();
  }

  // Bars
  const barW = Math.max(1, plotW / scores.length);
  scores.forEach((iou, i) => {
    const x = pad.left + i * barW;
    const barH = Math.max(1, iou * plotH);
    const y = pad.top + plotH - barH;
    ctx.fillStyle = iou >= threshold ? 'rgba(34,197,94,0.7)' : 'rgba(239,68,68,0.7)';
    ctx.fillRect(x, y, Math.max(barW - 0.5, 1), barH);
  });

  // Threshold line
  const threshY = pad.top + plotH * (1 - threshold);
  ctx.strokeStyle = '#eab308';
  ctx.lineWidth = 2;
  ctx.setLineDash([6, 4]);
  ctx.beginPath();
  ctx.moveTo(pad.left, threshY);
  ctx.lineTo(w - pad.right, threshY);
  ctx.stroke();
  ctx.setLineDash([]);

  // Labels
  ctx.fillStyle = '#7878a0';
  ctx.font = '11px Inter, sans-serif';
  ctx.textAlign = 'right';
  ctx.fillText('1.0', pad.left - 5, pad.top + 4);
  ctx.fillText(threshold.toFixed(2), pad.left - 5, threshY + 4);
  ctx.fillText('0.0', pad.left - 5, pad.top + plotH + 4);

  // Threshold label
  ctx.fillStyle = '#eab308';
  ctx.textAlign = 'left';
  ctx.fillText('threshold', w - pad.right + 4, threshY + 4);

  ctx.fillStyle = '#7878a0';
  ctx.textAlign = 'center';
  ctx.fillText('Frame 0', pad.left, h - 4);
  ctx.fillText('Frame ' + (scores.length - 1), w - pad.right, h - 4);
}

/* =============================================================
   STEP 6 — Results (full view)
   ============================================================= */

function showResults() {
  // IoU section
  const valResults = window._valResults;
  if (valResults) {
    $('#results-iou-section').style.display = 'block';
    const badge = $('#results-iou-badge');
    if (valResults.passed) {
      badge.className = 'iou-badge pass';
      badge.textContent = 'PASSED — All frames above threshold';
    } else {
      badge.className = 'iou-badge fail';
      badge.textContent = 'FAILED — ' + valResults.failed_count + ' frame(s) below threshold';
    }
    buildIoUSummary(valResults, '#results-iou-grid');
    // Draw chart after a brief delay so canvas is visible
    requestAnimationFrame(() => drawIoUChart('#results-iou-chart', valResults.all_scores || [], valResults.threshold));
  } else {
    $('#results-iou-section').style.display = 'none';
  }

  // Generated video section
  if (window._hasGeneratedVideo) {
    $('#results-gen-section').style.display = 'block';
    const origVid = $('#results-orig-video');
    const genVid = $('#results-gen-video');
    origVid.src = '/api/video/original';
    genVid.src = '/api/generated/video';

    // Sync playback
    origVid.onplay = () => { genVid.currentTime = origVid.currentTime; genVid.play(); };
    origVid.onpause = () => genVid.pause();
    origVid.onseeked = () => { genVid.currentTime = origVid.currentTime; };
  } else {
    $('#results-gen-section').style.display = 'none';
  }

  // Frame analysis viewer (always available after extraction)
  compState.currentFrame = 0;
  compState.imageCache = {};
  buildCompTabs();

  const slider = $('#frame-slider');
  slider.max = Math.max(0, compState.frameCount - 1);
  slider.value = 0;
  updateFrameInfo(0);
  loadCompFrame(0);

  buildSummary();
}

/* Fetch latest validation results before showing results */
async function fetchAndShowResults() {
  try {
    const r = await fetch('/api/validate/status');
    const j = await r.json();
    if (j.results) window._valResults = j.results;
  } catch(e) { /* ignore */ }

  try {
    const r = await fetch('/api/generate/status');
    const j = await r.json();
    window._hasGeneratedVideo = (j.status === 'complete' && j.generated_video);
  } catch(e) { /* ignore */ }

  showResults();
}

/* Override showStep for results to also fetch data */
const _origShowStep = showStep;
showStep = function(name) {
  if (name === 'results') {
    _origShowStep(name);
    fetchAndShowResults();
    return;
  }
  _origShowStep(name);
};

/* ---- Comparison viewer (Frame Analysis) ---- */

function buildCompTabs() {
  const tabContainer = $('#comp-tabs');
  tabContainer.innerHTML = '';

  const views = [];
  if (compState.outputs['pose_skater'])     views.push({key: 'pose_skater',     label: 'Pose'});
  if (compState.outputs['mask_skateboard']) views.push({key: 'mask_skateboard', label: 'Board Mask'});
  if (compState.outputs['mask_skater'])     views.push({key: 'mask_skater',     label: 'Skater Mask'});
  if (compState.outputs['mask_skateboard'] || compState.outputs['mask_skater']) {
    views.push({key: 'overlay', label: 'Overlay'});
  }

  if (views.length === 0) {
    tabContainer.innerHTML = '<span style="color:var(--text-muted);font-size:.78rem;">No outputs</span>';
    return;
  }

  compState.activeView = views[0].key;

  views.forEach(v => {
    const btn = document.createElement('button');
    btn.className = 'comp-tab' + (v.key === compState.activeView ? ' active' : '');
    btn.textContent = v.label;
    btn.dataset.view = v.key;
    btn.addEventListener('click', () => {
      $$('.comp-tab').forEach(b => b.classList.remove('active'));
      btn.classList.add('active');
      compState.activeView = v.key;
      loadCompFrame(compState.currentFrame);
    });
    tabContainer.appendChild(btn);
  });
}

function framePath(dir, idx) {
  const info = compState.outputs[dir];
  if (!info) return null;
  const ext = info.ext || '.png';
  return `/output/${dir}/frame_${String(idx).padStart(5, '0')}${ext}`;
}

function loadImage(url) {
  if (compState.imageCache[url]) {
    return Promise.resolve(compState.imageCache[url]);
  }
  return new Promise((resolve, reject) => {
    const img = new Image();
    img.onload = () => {
      compState.imageCache[url] = img;
      const keys = Object.keys(compState.imageCache);
      if (keys.length > 200) {
        delete compState.imageCache[keys[0]];
      }
      resolve(img);
    };
    img.onerror = reject;
    img.src = url;
  });
}

function loadCompFrame(idx) {
  compState.currentFrame = idx;

  // Left panel: original frame
  const leftBody = $('#comp-left-body');
  const origPath = framePath('frames_original', idx);
  if (origPath) {
    loadImage(origPath).then(img => {
      leftBody.innerHTML = '';
      const el = document.createElement('img');
      el.src = img.src;
      el.alt = `Original frame ${idx}`;
      leftBody.appendChild(el);
    }).catch(() => {
      leftBody.innerHTML = '<div class="placeholder">Frame not available</div>';
    });
  } else {
    const fallback = `/api/frame/original/${idx}`;
    leftBody.innerHTML = `<img src="${fallback}" alt="Original frame ${idx}">`;
  }

  // Right panel
  const rightBody = $('#comp-right-body');
  const view = compState.activeView;

  if (view === 'overlay') {
    drawOverlayFrame(idx, rightBody);
  } else {
    const path = framePath(view, idx);
    if (path) {
      loadImage(path).then(img => {
        rightBody.innerHTML = '';
        const el = document.createElement('img');
        el.src = img.src;
        el.alt = `${view} frame ${idx}`;
        rightBody.appendChild(el);
      }).catch(() => {
        rightBody.innerHTML = '<div class="placeholder">Frame not available</div>';
      });
    } else {
      rightBody.innerHTML = '<div class="placeholder">Output not available</div>';
    }
  }

  preloadNearby(idx);
}

function drawOverlayFrame(idx, container) {
  const origPath = framePath('frames_original', idx);
  const maskDir = compState.outputs['mask_skateboard'] ? 'mask_skateboard' : 'mask_skater';
  const maskPath = framePath(maskDir, idx);

  if (!origPath || !maskPath) {
    container.innerHTML = '<div class="placeholder">Overlay not available</div>';
    return;
  }

  Promise.all([loadImage(origPath), loadImage(maskPath)]).then(([origImg, maskImg]) => {
    let canvas = container.querySelector('canvas');
    if (!canvas) {
      container.innerHTML = '';
      canvas = document.createElement('canvas');
      container.appendChild(canvas);
    }
    const w = origImg.naturalWidth;
    const h = origImg.naturalHeight;
    canvas.width = w;
    canvas.height = h;
    canvas.style.width = '100%';
    canvas.style.height = 'auto';
    canvas.style.display = 'block';

    const ctx = canvas.getContext('2d');
    ctx.drawImage(origImg, 0, 0, w, h);

    const tmp = document.createElement('canvas');
    tmp.width = w; tmp.height = h;
    const tctx = tmp.getContext('2d');
    tctx.drawImage(maskImg, 0, 0, w, h);
    const maskData = tctx.getImageData(0, 0, w, h);

    const overlayData = ctx.createImageData(w, h);
    const color = maskDir === 'mask_skateboard' ? [249, 115, 22] : [59, 130, 246];
    for (let i = 0; i < maskData.data.length; i += 4) {
      if (maskData.data[i] > 127) {
        overlayData.data[i]     = color[0];
        overlayData.data[i + 1] = color[1];
        overlayData.data[i + 2] = color[2];
        overlayData.data[i + 3] = 90;
      }
    }
    tctx.putImageData(overlayData, 0, 0);
    ctx.drawImage(tmp, 0, 0);

    if (maskDir === 'mask_skateboard' && compState.outputs['mask_skater']) {
      const skaterMaskPath = framePath('mask_skater', idx);
      if (skaterMaskPath) {
        loadImage(skaterMaskPath).then(skaterImg => {
          tctx.clearRect(0, 0, w, h);
          tctx.drawImage(skaterImg, 0, 0, w, h);
          const sd = tctx.getImageData(0, 0, w, h);
          const od = ctx.createImageData(w, h);
          for (let i = 0; i < sd.data.length; i += 4) {
            if (sd.data[i] > 127) {
              od.data[i]     = 59;
              od.data[i + 1] = 130;
              od.data[i + 2] = 246;
              od.data[i + 3] = 80;
            }
          }
          tctx.putImageData(od, 0, 0);
          ctx.drawImage(tmp, 0, 0);
        }).catch(() => {});
      }
    }
  }).catch(() => {
    container.innerHTML = '<div class="placeholder">Could not generate overlay</div>';
  });
}

function preloadNearby(idx) {
  const dirs = ['frames_original', compState.activeView];
  for (const dir of dirs) {
    if (dir === 'overlay') continue;
    for (let offset = 1; offset <= 5; offset++) {
      const fi = idx + offset;
      if (fi < compState.frameCount) {
        const p = framePath(dir, fi);
        if (p && !compState.imageCache[p]) {
          const img = new Image();
          img.src = p;
          img.onload = () => { compState.imageCache[p] = img; };
        }
      }
    }
  }
}

function updateFrameInfo(idx) {
  const fps = compState.fps || 30;
  const time = (idx / fps).toFixed(2);
  const total = ((compState.frameCount - 1) / fps).toFixed(2);
  $('#frame-info').textContent = `Frame ${idx} / ${compState.frameCount - 1}  (${time}s / ${total}s)`;
}

/* Slider events */
$('#frame-slider').addEventListener('input', (e) => {
  const idx = parseInt(e.target.value, 10);
  compState.currentFrame = idx;
  updateFrameInfo(idx);
  loadCompFrame(idx);
});

/* Play / Pause */
$('#btn-play').addEventListener('click', togglePlay);

function togglePlay() {
  if (compState.playing) {
    stopPlay();
  } else {
    startPlay();
  }
}

function startPlay() {
  compState.playing = true;
  $('#btn-play').innerHTML = '&#9646;&#9646;';
  const interval = 1000 / (compState.fps || 30);
  compState.playTimer = setInterval(() => {
    let next = compState.currentFrame + 1;
    if (next >= compState.frameCount) next = 0;
    compState.currentFrame = next;
    $('#frame-slider').value = next;
    updateFrameInfo(next);
    loadCompFrame(next);
  }, Math.max(interval, 33));
}

function stopPlay() {
  compState.playing = false;
  $('#btn-play').innerHTML = '&#9654;';
  if (compState.playTimer) {
    clearInterval(compState.playTimer);
    compState.playTimer = null;
  }
}

function buildSummary() {
  const grid = $('#summary-grid');
  grid.innerHTML = '';

  const cards = [
    {label: 'Frames', value: compState.frameCount, detail: `${compState.fps.toFixed(1)} fps`},
    {label: 'Duration', value: compState.duration.toFixed(1) + 's', detail: ''},
  ];

  if (compState.outputs['pose_skater']) {
    cards.push({label: 'Pose Frames', value: compState.outputs['pose_skater'].count, detail: 'pose_skater/'});
  }
  if (compState.outputs['mask_skateboard']) {
    cards.push({label: 'Board Masks', value: compState.outputs['mask_skateboard'].count, detail: 'mask_skateboard/'});
  }
  if (compState.outputs['mask_skater']) {
    cards.push({label: 'Skater Masks', value: compState.outputs['mask_skater'].count, detail: 'mask_skater/'});
  }

  cards.forEach(c => {
    const div = document.createElement('div');
    div.className = 'summary-card';
    div.innerHTML = `
      <div class="sc-label">${c.label}</div>
      <div class="sc-value">${c.value}</div>
      ${c.detail ? '<div class="sc-detail">' + c.detail + '</div>' : ''}
    `;
    grid.appendChild(div);
  });
}

/* Process another video — full reset */
$('#btn-new').addEventListener('click', () => {
  stopPlay();
  compState.imageCache = {};
  compState.outputs = {};
  window._frameB64 = null;
  window._valResults = null;
  window._hasGeneratedVideo = false;
  fileInput.value = '';
  ytInput.value = '';
  $('#video-info').classList.remove('show');

  // Reset Generate step
  $('#gen-progress-wrap').style.display = 'none';
  $('#gen-btn-row').style.display = 'flex';
  $('#gen-btn-row').innerHTML = `
    <button class="btn btn-primary" id="btn-generate" onclick="startGeneration()">Generate Reskin</button>
    <button class="btn btn-outline" id="btn-skip-generate" onclick="showStep('results'); showResults();">Skip to Results</button>
  `;
  $('#positive-prompt').value = '';
  $('#comfyui-status').textContent = '';
  $('#gen-summary-grid').innerHTML = '';

  // Reset Validate step
  $('#val-progress-wrap').style.display = 'none';
  $('#val-results-wrap').style.display = 'none';
  $('#val-btn-row').style.display = 'flex';
  $('#val-btn-row').innerHTML = `
    <button class="btn btn-success" id="btn-validate" onclick="startValidation()">Run Validation</button>
    <button class="btn btn-outline" id="btn-back-generate" onclick="showStep('generate')">Back</button>
    <button class="btn btn-outline" id="btn-skip-validate" onclick="showStep('results'); showResults();">Skip to Results</button>
  `;
  $('#val-video-name').textContent = '';
  $('#val-video-input').value = '';

  // Reset Results step
  $('#results-iou-section').style.display = 'none';
  $('#results-gen-section').style.display = 'none';

  showStep('upload');
});

/* =============================================================
   INIT — check if video was pre-loaded via CLI, or auto-load default
   ============================================================= */
const DEFAULT_VIDEO_URL = 'https://www.youtube.com/shorts/wPpXDBMk8-E';

(async () => {
  try {
    const r = await fetch('/api/state');
    const j = await r.json();

    // Sync ComfyUI server address from backend (may come from env var / CLI)
    if (j.comfyui_server) {
      $('#comfyui-server').value = j.comfyui_server;
    }

    if (j.has_video && j.status === 'idle') {
      // Pre-loaded via CLI
      uploadSt.innerHTML = '<span class="spinner"></span> Reading pre-loaded video ...';
      const fd = new FormData();
      const lr = await fetch('/api/load', {method:'POST', body: fd});
      const lj = await lr.json();
      if (lr.ok) onVideoLoaded(lj, j.video_path || 'Pre-loaded video');
      else uploadSt.textContent = '';
    } else if (j.status === 'idle' && !j.has_video) {
      // No pre-loaded video — auto-load the default YouTube demo
      const defaultUrl = $('#yt-url').value.trim() || DEFAULT_VIDEO_URL;
      if (defaultUrl) {
        loadUrl(defaultUrl);
      }
    }
  } catch(e) { /* server may not be ready yet */ }
})();
</script>

</body>
</html>
